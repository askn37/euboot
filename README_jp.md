# euboot -- EDBG USB bootloader for AVR-DU series

*Switching document languages* : __æ—¥æœ¬èª__, [English](README.md)

## æ©Ÿèƒ½

- AVR-DU ã‚·ãƒªãƒ¼ã‚ºå°‚ç”¨ USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã€‚
- æ¨™æº– USB-HID/CMSIS-DAP/EDBG ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã€AVRDUDE<=8.0 ã‹ã‚‰ã¯ `jtag3updi` ãƒ‡ãƒã‚¤ã‚¹ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹ã€‚
- USB Full-Speed ã®ä¸Šé™ã«è¿‘ã„ã€é«˜é€Ÿãªãƒ¡ãƒ¢ãƒªã®èª­ã¿æ›¸ãé€Ÿåº¦ã€‚
- ãƒ•ãƒƒãƒˆãƒ—ãƒªãƒ³ãƒˆã¯ 2.5KiB æœªæº€ã€‚

## é–‹ç™ºã®ç†ç”±

AVR-DU ã‚·ãƒªãƒ¼ã‚ºã¯ã€USB å‘¨è¾ºæ©Ÿå™¨ã‚’å†…è”µã—ãŸå”¯ä¸€ã® modernAVR ä¸–ä»£ã ãŒã€ä»¥å‰ã®åŒæ§˜ã®è£½å“ (ATMEL ä¸–ä»£) ã¨ã¯ç•°ãªã‚Šã€DFU ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã¯ä»˜å±ã—ã¦ãŠã‚‰ãšã€ãƒ™ã‚¢ãƒ¡ã‚¿ãƒ« ãƒãƒƒãƒ— ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã¯å¸¸ã«ç©ºã ã€‚

ã“ã‚Œã¯ ATMEL ãŒ USB-IF DFU æ¨™æº–é–‹ç™ºã®æ­£è¦ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã£ãŸã®ã«å¯¾ã—ã€Microchip ã¯ãã†ã§ã¯ãªã‹ã£ãŸã“ã¨ãŒä¸€å› ã ã‚ã†ã€‚ãã®ãŸã‚å°†æ¥çš„ã« DFU ã‚µãƒãƒ¼ãƒˆãŒæä¾›ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã¾ã‚ŠæœŸå¾…ã§ããªã„ã€‚

ç¾åœ¨ã€AVRDUDE ã«ã¯ USB-CDC ã¨ USB-HID ã¨ã„ã† 2 ã¤ã®ä»£æ›¿ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒã‚ã‚‹ã€‚CDC (VCP) ã¯éå¸¸ã«ã‚ˆãä½¿ã‚ã‚Œã¦ã„ã‚‹ãŒã€é€šä¿¡ã‚’ãƒã‚¤ãƒˆã«åˆ†å‰²ã—ã¦è§£é‡ˆã—ãªã‘ã‚Œã°ãªã‚‰ãšã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒè¤‡é›‘ã§é…ãã€SRAM ç®¡ç†ã«å¤šãã®åŠ´åŠ›ãŒå¿…è¦ã§ã‚ã‚Šã€ã•ã‚‰ã«æ‚ªã„ã“ã¨ã«æ–°ã—ã„ãƒãƒƒãƒ—ã®ãƒ¡ãƒ¢ãƒªã‚’é©åˆ‡ã«ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã«ã¯ AVRDUDE ã«æ–°ã—ã„ãƒ‘ãƒƒãƒãŒå¿…è¦ã«ãªã‚‹ãªã©å¤šãã®æ¬ ç‚¹ãŒã‚ã‚Šã€æ–°è¦é–‹ç™ºã§é¸æŠã™ã‚‹ã«ã¯ã€åˆ©ç‚¹ãŒã»ã¨ã‚“ã©è¦‹å‡ºã›ãªã„ã€‚

ä¸€æ–¹ã€USB-HID ã‚’ä½¿ç”¨ã—ãŸãƒãƒ«ã‚¯è»¢é€é€šä¿¡ã¯ USB ã®å°‚é–€çŸ¥è­˜ãŒå¿…è¦ã§ã‚ã‚‹ãŸã‚ã€ã‚ã¾ã‚Šä½¿ã‚ã‚Œã¦ã„ãªã„ã€‚ã—ã‹ã— CMSIS-DAP ãŠã‚ˆã³ EDBG ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€`jtag3updi` ã‚‚å‡¦ç†ã§ãã‚‹ [UPDI4AVR-USB](https://github.com/askn37/UPDI4AVR-USB/) ãŒã€ä»Šã‚„æ‰‹å…ƒã«ã‚ã‚‹ã€‚ã“ã‚Œã‚’ãƒ™ãƒ¼ã‚¹ã«å¿…è¦ãªéƒ¨åˆ†ã®ã¿ã‚’å®Ÿè£…ã—ã€NVM åˆ¶å¾¡ã‚’è¿½åŠ ã™ã‚‹ã®ã¯å®¹æ˜“ã„ã“ã¨ã ã€‚çµæœã¯è‰¯å¥½ã§ã€ãƒ•ãƒƒãƒˆãƒ—ãƒªãƒ³ãƒˆ 2.5KiB ã® `jtag3updi` ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ã‚’ä½œã‚Šå‡ºã™äº‹ãŒã§ããŸã€‚DFU ã»ã©å°ã•ãã¯ãªã„ãŒå®Ÿç”¨ä¸Šã¯ååˆ†ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã ã€‚ã¾ãŸå†…éƒ¨ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå°‘ãªã„ãŸã‚ã€USB Full-Speed ã®ä¸Šé™ã«è¿‘ã„ãƒ¡ãƒ¢ãƒªèª­ã¿å–ã‚Šé€Ÿåº¦ã‚’ç°¡å˜ã«å®Ÿç¾ã§ãã‚‹ã€‚

## ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚‚ã®

ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€æ¬¡ã®ç’°å¢ƒãŒå¿…è¦ã :

#### [MultiX Zinnia Product SDK [modernAVR] @0.3.0+](https://github.com/askn37/multix-zinnia-sdk-modernAVR)

Arduino IDE/CLI ã® ãƒœãƒ¼ãƒ‰ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ç°¡å˜ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ãƒ™ã‚¢ãƒ¡ã‚¿ãƒ«é–‹ç™ºSDKã€‚AVR-LIBC ã‚’ä½¿ã„ã‚„ã™ãã™ã‚‹ã•ã¾ã–ã¾ãªãƒã‚¯ãƒ­ã‚’å‚™ãˆã¦ãŠã‚Šã€Arduino-API ã«è¿‘ã„ä½¿ç”¨æ„Ÿã§ä½ãƒ¬ãƒ™ãƒ« ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã§ãã‚‹ã€‚åŒæ™‚ã« AVRDUDE 8.0+ ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã€‚

#### [Arduino-CLI @1.0.3+](https://arduino.github.io/arduino-cli/1.0/installation/)

ä»˜å±ã® Makefile ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã«å¿…è¦ã€‚
ã“ã‚ŒãŒãªãã¨ã‚‚ modernAVR SDK ã ã‘ã§ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã§ãã‚‹ãŒã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šãŒç…©é›‘ã«ãªã‚‹ã€‚

> [!HINT]
> Windows ç’°å¢ƒã§ã¯ã€`make` ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã€‚WSL ãªã©ã®æ–¹æ³•ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

#### AVR-DU ã‚·ãƒªãƒ¼ã‚ºç”¨ã® UPDI äº’æ›ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼

ã“ã‚Œã¯ä¸»ã« `PICKit4` ãªã©ã§ã‚ã‚‹ã€‚ã ãŒä¸–ç•Œã§æœ€ã‚‚å…¥æ‰‹ã—ã‚„ã™ãå®‰ä¾¡ãªã®ã¯ ["AVR64DU32 Curiosity Nano : EV59F82A"](https://www.microchip.com/en-us/development-tool/ev59f82a) ã ã‚ã†ã€‚ã¾ãšã“ã‚Œã‚’å…¥æ‰‹ã™ã‚Œã°ã€AVR64DU32 ã®å®Œå…¨ãªã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³é–‹ç™ºç’°å¢ƒãŒã“ã‚Œä¸€ã¤ã§æƒã†ã€‚ã¾ãŸ [UPDI4AVR-USB](https://github.com/askn37/UPDI4AVR-USB/) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã€AVRDUDEã‹ã‚‰ã¯ `PICKit4` ã®ã‚ˆã†ãª UPDIãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ã‚‚ã§ãã‚‹ã€‚è©³ç´°ã¯å„ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã®ã“ã¨ã€‚

## ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ä½œæˆã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

modernAVR SDKã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€Arduino-CLIã¨AVRDUDE 8.0ã‚’å®Ÿè¡Œãƒ‘ã‚¹ã«è¿½åŠ ã—ã€æº–å‚™ãŒã§ããŸã‚‰`euboot`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦`make all`ã‚’å®Ÿè¡Œã™ã‚‹ã€‚ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯`hex`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã‚‹ã€‚

```sh
euboot $ make all
```

> [!HINT]
> `Perl5`å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã€hex/binãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯`CRCSCAN`å‘¨è¾ºæ©Ÿå™¨ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã® CRC32 ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ã€‚

ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚ã“ã®ä¾‹ã§ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¯ CURIOSITY NANO (CNANO) ã ãŒã€ã“ã‚Œã«ã¯ `pkobn_updi` ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ç°¡å˜ã«è©¦ã™äº‹ãŒã§ãã‚‹ã€‚

```sh
euboot $ avrdude -cpkobn_updi -pavr64du32 -Uflash:w:hex/euboot_LF2_SF6.hex:i -Ufuses:w:hex/euboot_LF2_SF6.fuse:i
```

ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã™ã‚‹ã¨ã€ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã¯ã™ãã«å‹•ä½œã‚’é–‹å§‹ã™ã‚‹ã€‚CNANO ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ USB ãƒãƒ¼ãƒˆã«ä½•ã‚‚æ¥ç¶šã•ã‚Œã¦ã„ãªã„å ´åˆã€LED (PF2) ã¯æ¬¡ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ç‚¹æ»…ã—ç¶šã‘ã‚‹ã€‚ã“ã‚Œã¯ãƒ›ã‚¹ãƒˆ PC ã¨ã® USB åˆ—æŒ™ãŒå®Œäº†ã—ã¦ã„ãªã„ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã€‚

- LED(PF2): ğŸŸ âš«ï¸âš«ï¸âš«ï¸ (USBåˆ—æŒ™ã‚’å¾…æ©Ÿä¸­)

2æœ¬ç›®ã® USB ã‚±ãƒ¼ãƒ–ãƒ«ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ USB ãƒãƒ¼ãƒˆã«æ¥ç¶šã™ã‚‹ã‹ã€USBã‚±ãƒ¼ãƒ–ãƒ«ã‚’ãƒ‡ãƒãƒƒã‚¬ãƒ¼ãƒãƒ¼ãƒˆã‹ã‚‰å·®ã—æ›¿ãˆã‚‹ã¨ã€LED ãŒæ¬¡ã®ç‚¹æ»…ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¤‰ã‚ã‚Šã€EDBG ãƒ—ãƒ­ãƒˆã‚³ãƒ«é€šä¿¡ã‚’é–‹å§‹ã™ã‚‹æº–å‚™ãŒã§ããŸã“ã¨ã‚’ç¤ºã™ã€‚

- LED(PF2): ğŸŸ ğŸŸ âš«ï¸âš«ï¸ (ã‚¹ã‚¿ãƒ³ãƒã‚¤ãƒ¢ãƒ¼ãƒ‰)

æº–å‚™å®Œäº†ï¼Ÿ ã§ã¯ USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ãŒæ­£ã—ãå¿œç­”ã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã‚ˆã†ã€‚`-P` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¨˜è¿°ã«æ³¨æ„ã€‚

```sh
$ avrdude -Pusb:04d8:0b12 -cjtag3updi -pavr64du32 -v
```

```text
Avrdude version 8.0-20241010 (0b92721a)
Copyright see https://github.com/avrdudes/avrdude/blob/main/AUTHORS

System wide configuration file is /usr/local/etc/avrdude.conf
User configuration file is /Users/user/.avrduderc

Using port            : usb:04d8:0b12
Using programmer      : jtag3updi
AVR part              : AVR64DU32
Programming modes     : SPM, UPDI
Programmer type       : JTAGICE3_UPDI
Description           : Atmel AVR JTAGICE3 in UPDI mode
ICE HW version        : 52
ICE FW version        : 3.72 (rel. 48)
Serial number         : euboot:CMSIS-DAP:EDBG
Vtarget               : 3.30 V
PDI/UPDI clk          : 2560 kHz

Partial Family_ID returned: "AVR "
Silicon revision: 1.3

AVR device initialized and ready to accept instructions
Device signature = 1E 96 21 (AVR64DU32)

Avrdude done.  Thank you.
```

ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢å›ºæœ‰ã®æƒ…å ±ã¯ã€`ICE HW ãƒãƒ¼ã‚¸ãƒ§ãƒ³` ä»¥é™ã«ãƒªã‚¹ãƒˆã•ã‚Œã‚‹ã€‚AVRDUDE ã«ã“ã‚Œã‚‰ã®ç‰¹å®šæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ãŒãªã„ãŸã‚ã€é …ç›®åã¨å†…å®¹ãŒä¸€è‡´ã—ãªã„ã®ã¯ä»•æ§˜ã ã€‚ä»£ã‚ã‚Šã«æœªä½¿ç”¨ã®é …ç›®ã‚’ä½¿ã£ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã€‚

- __ICE HW ãƒãƒ¼ã‚¸ãƒ§ãƒ³__: å¸¸ã« 52ã€‚ã“ã‚Œã¯å…ƒã€… `4` ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚Šã€NVM ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¤ºã™ã€‚
- __ICE FW ãƒãƒ¼ã‚¸ãƒ§ãƒ³__: USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨æ›´æ–°ç•ªå·ã‚’ç¤ºã™ã€‚
- __ã‚·ãƒªã‚¢ãƒ«ç•ªå·__: USB ãƒ‡ãƒã‚¤ã‚¹è£½å“æ–‡å­—åˆ—ã‚’ç¤ºã™ã€‚USB ã‚·ãƒªã‚¢ãƒ«ç•ªå·æ–‡å­—åˆ—ã¯ä½¿ç”¨ã•ã‚Œãªã„ãŸã‚ã€ä¸¡æ–¹ã¨ã‚‚åŒã˜æ–‡å­—åˆ—ã«ãªã£ã¦ã„ã‚‹ã€‚
- __Vtarget__: VDD ã«ä¾›çµ¦ã•ã‚Œã¦ã„ã‚‹ç¾åœ¨ã®å‹•ä½œé›»åœ§ã‚’ç¤ºã™ã€‚
- __PDI/UPDI clk__: ã“ã‚Œã¯å®Ÿéš›ã®å‹•ä½œé€Ÿåº¦ã§ã¯ãªãã€`FUSE_BOOTSIZE` è¨­å®šã‹ã‚‰è¨ˆç®—ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ã® ãƒ—ãƒ­ã‚°ãƒ©ãƒ é–‹å§‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã ã€‚ãŸã¨ãˆã° `2560` ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãŒ ãƒ—ãƒ­ã‚°ãƒ©ãƒ é–‹å§‹ã‚¢ãƒ‰ãƒ¬ã‚¹ `0x0A00` ã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¤ºã™ã€‚`0` ã®å ´åˆã€å¿…è¦ãª FUSEã¯æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„ã€‚

å‰è¿°ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«æ§‹æˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ¬¡ã®ã‚ˆã†ã«ã‚¹ã‚¿ãƒ³ãƒã‚¤çŠ¶æ…‹ã® USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ã§æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ã€‚`-D` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æ¨å¥¨ã€‚ãƒ¡ãƒ¢ãƒªã®èª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿ä¸­ã«ç‚¹æ»…ã™ã‚‹ LED ã¯ã€æ¬¡ã®ã‚ˆã†ã«å¤‰ã‚ã‚‹:

- LED(PF2): ğŸŸ ğŸŸ ğŸŸ ğŸŸ  (é€šä¿¡ä¸­)

```sh
$ avrdude -Pusb:04d8:0b12 -cjtag3updi -pavr64du32 -v -D -Uflash:w:USERAPP.hex:i
```

åŒæ§˜ã« `-U` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€`eeprom`ã€`userrow`ã€ãŠã‚ˆã³ `bootrow` ã®æ›¸ãè¾¼ã¿ã¨èª­ã¿å–ã‚Šã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚
`fuse(s)` ãŠã‚ˆã³ `lock` ã¯èª­ã¿å–ã‚Šå°‚ç”¨ã§ã‚ã‚Šã€å¤‰æ›´ã§ããªã„ã€‚

## USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®æœ‰åŠ¹åŒ–

ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã¾ã æ›¸ãè¾¼ã¾ã‚Œã¦ãŠã‚‰ãšã€ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãŒç©ºã®å ´åˆã€USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®å®Ÿè¡ŒãŒå„ªå…ˆã•ã‚Œã‚‹ãŒã€ã²ã¨ãŸã³ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ã¨ã€USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã€‚ãã†ã§ã¯ãªã USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ã«ã¯ã€`SW0(PF6)` ã‚’æŠ¼ã—ãŸã¾ã¾ CNANO ã®é›»æºã‚’å…¥ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

æˆåŠŸã™ã‚‹ã¨ã€LED ãŒç‚¹æ»…ã—ã¦ã‚¹ã‚¿ãƒ³ãƒã‚¤ ãƒ¢ãƒ¼ãƒ‰ã‚’ç¤ºã™ã€‚

æ—¢å®šã® `FUSES` è¨­å®šã§ã¯ã€`SW0(PF6)` ã¯ãƒãƒ¼ãƒ‰ ãƒªã‚»ãƒƒãƒˆ ã‚¹ã‚¤ãƒƒãƒã¨ã—ã¦æ©Ÿèƒ½ã›ãšã€é€šå¸¸ã® GPIO å…¥åŠ›ã ã€‚ã“ã‚Œã‚’ ãƒªã‚»ãƒƒãƒˆ ã‚¹ã‚¤ãƒƒãƒã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§å¿…è¦ãªã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€WDT æ“ä½œã¨ SWRST æ“ä½œã® 2 ã¤ã®ãƒªã‚»ãƒƒãƒˆæ–¹æ³•ã‚’å®Ÿè£…ã§ãã‚‹ã€‚WDT ãƒªã‚»ãƒƒãƒˆã¯å¸¸ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ– ã‚¹ã‚¤ãƒƒãƒã‚’ç„¡è¦–ã™ã‚‹ã€‚SWRST ãƒªã‚»ãƒƒãƒˆã¯ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ– ã‚¹ã‚¤ãƒƒãƒãŒ LOW ã®å ´åˆã« USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ã€‚

## SPM ã‚¹ãƒ‹ãƒšãƒƒãƒˆ

USB ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ã®æœ€åˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€`PROGMEM` é ˜åŸŸã® `PROGMEM_START` ã‹ã‚‰å§‹ã¾ã‚‹ã€‚ã“ã“ã«ã¯ç‰¹åˆ¥ãªãƒã‚¸ãƒƒã‚¯ ãƒŠãƒ³ãƒãƒ¼ã¨ SPM ã‚¹ãƒ‹ãƒšãƒƒãƒˆ ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹ã€‚

|Series|Address|Magic number: uint32_t (LE)|
|-|-|-|
|AVR_DA/DB/DD/DU/EA/EB|PROGMEM_START + 2 bytes|0x95089361|

> [!TIPS]
> `(pgm_read_dword(PROGMEM_START + 2) == 0x95089361L`

|Offset|HWV=52|OP code|
|-|-|-|
|$02|nvm_stz|ST Z+, R22 \n RET
|$06|nvm_ldz|LD R24, Z+ \n RET
|$0A|nvm_spm|SPM Z+     \n RET
|$0E|nvm_cmd|(function)

ã“ã‚Œã‚‰ã¯ BOOT é ˜åŸŸä¿è­·ç‰¹æ¨©ã‚’ä½¿ç”¨ã—ã¦ã€CODE/APPEND ãŠã‚ˆã³ BOOTROW é ˜åŸŸã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’æ¶ˆå»/æ›¸ãæ›ãˆã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ã€‚

> å®Ÿéš›ã®ä½¿ç”¨ä¾‹ã«ã¤ã„ã¦ã¯ã€[[FlashNVM ãƒ„ãƒ¼ãƒ«ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹]](https://github.com/askn37/askn37.github.io/wiki/FlashNVM)ã‚’å‚ç…§ã®ã“ã¨ã€‚

## Copyright and Contact

Twitter(X): [@askn37](https://twitter.com/askn37) \
BlueSky Social: [@multix.jp](https://bsky.app/profile/multix.jp) \
GitHub: [https://github.com/askn37/](https://github.com/askn37/) \
Product: [https://askn37.github.io/](https://askn37.github.io/)

Copyright (c) askn (K.Sato) multix.jp \
Released under the MIT license \
[https://opensource.org/licenses/mit-license.php](https://opensource.org/licenses/mit-license.php) \
[https://www.oshwa.org/](https://www.oshwa.org/)
